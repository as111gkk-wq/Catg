<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“· Ø®Ø²Ø§Ù†Ø© Ø®Ø§ØµØ© - Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f4f7f9;
        }
        #camera-feed {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            border: 3px solid #3498db;
            border-radius: 8px;
            display: block; /* Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡Ø§ Ø¹Ù†ØµØ± ÙƒØªÙ„ÙˆÙŠ */
        }
        #capture-btn {
            background-color: #2ecc71;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #capture-btn:hover {
            background-color: #27ae60;
        }
        #status-message {
            margin-top: 20px;
            font-weight: bold;
            color: #e74c3c;
        }
        /* Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ canvas Ù„Ø£Ù†Ù‡ ÙŠØ³ØªØ®Ø¯Ù… Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø· */
        #photo-canvas {
            display: none;
        }
    </style>
</head>
<body>

    <h1>ğŸ“¸ Ø®Ø²Ø§Ù†ØªÙŠ Ø§Ù„Ø®Ø§ØµØ©</h1>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø¨ÙˆØª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.</p>

    <video id="camera-feed" autoplay playsinline></video>

    <canvas id="photo-canvas"></canvas>

    <button id="capture-btn">ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ¥Ø±Ø³Ø§Ù„</button>

    <p id="status-message"></p>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('photo-canvas');
        const captureButton = document.getElementById('capture-btn');
        const statusMessage = document.getElementById('status-message');
        
        // 1. Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCamera() {
            try {
                // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙˆØ¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø³ØªÙ‚Ø±Ø©
                const constraints = { video: { 
                    facingMode: 'user', // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                    width: { ideal: 640 }, 
                    height: { ideal: 480 } 
                } }; 
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                statusMessage.textContent = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„.';
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ", err);
                statusMessage.textContent = 'â›” ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ©.';
            }
        }

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‡Ù†Ø§)
        captureButton.addEventListener('click', () => {
            statusMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.';
            captureButton.disabled = true;

            // ğŸ›‘ Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ù„Ù…Ø¯Ø© 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ğŸ›‘
            setTimeout(() => {
                
                // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù€ Canvas Ø¨Ù†ÙØ³ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù€ Canvas
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù€ Canvas Ø¥Ù„Ù‰ Base64 (Ø¨ØµÙŠØºØ© JPEG)
                const imageDataURL = canvas.toDataURL('image/jpeg', 0.8); // 0.8 Ù‡ÙŠ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
                sendPhotoToServer(imageDataURL);

            }, 500); // 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©)
        });

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ
        async function sendPhotoToServer(imageData) {
            // ğŸ›‘ ØªÙ… ØªØµØ­ÙŠØ­ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø®Ø§Ø¯Ù… Render ğŸ›‘
            const BACKEND_URL = 'https://vvvvvv-1.onrender.com/upload-photo'; 
            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© (Base64) Ø¯Ø§Ø®Ù„ Ø¬Ø³Ù… Ø§Ù„Ø·Ù„Ø¨
                    body: JSON.stringify({ image: imageData })
                });

                if (response.ok) {
                    statusMessage.textContent = 'âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!';
                } else {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    statusMessage.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${errorData.message || response.statusText}`;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…:', error);
                statusMessage.textContent = 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„.';
            } finally {
                captureButton.disabled = false;
            }
        }

        // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        startCamera();
    </script>
</body>
</html>
